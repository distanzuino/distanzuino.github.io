<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distance Dashboard</title>
  <style>
    /* Apply Futura PT globally */
    body {
      font-family: 'futura-pt', sans-serif;
      font-style: normal;
      font-weight: 400;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }

    /* Top header for logo and connect button */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .logo img {
      max-height: 50px;
    }

    /* Connect/Disconnect Button */
    .connect-btn {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .connect-btn.disconnected {
      background-color: #FF4136;
    }

    /* Dashboard layout */
    .dashboard {
      display: flex;
      flex-direction: column;
      max-width: 600px;
      margin-bottom: 40px;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Card styles */
    .card {
      margin-bottom: 20px;
      text-align: center;
    }

    .card-title {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .card-content {
      font-size: 2.5rem;
      font-weight: bold;
    }

    /* Card Grid (Distance and Frequency Side-by-Side) */
    .card-grid {
      display: flex;
      justify-content: space-between;
    }

    .card-grid .card {
      flex: 1;
      margin-right: 20px;
    }

    .card-grid .card:last-child {
      margin-right: 0;
    }

    /* Chart container */
    .chart-container {
      height: 300px;
    }

    /* Styling for greyed out when disconnected */
    .disconnected {
      color: #aaa; /* Grey color */
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- Header Section: Logo and Connect/Disconnect Button -->
  <div class="header">
    <div class="logo">
      <img src="logoDistanzuino.jpg" alt="Distanzuino Logo">
    </div>
    <button id="connect-btn" class="connect-btn">Connect</button>
  </div>

  <!-- Dashboard for Distance 1 -->
  <div class="dashboard" id="dashboard1">
    <!-- Distance and Frequency Cards -->
    <div class="card-grid">
      <div class="card" id="distance1-card">
        <div class="card-title">Current Distance 1</div>
        <div class="card-content" id="distance1-display">0.00 cm</div>
      </div>
      <div class="card" id="frequency1-card">
        <div class="card-title">Current Frequency 1</div>
        <div class="card-content" id="frequency1-display">0.00 Hz</div>
      </div>
    </div>

    <!-- Distance 1 History Chart -->
    <div class="card">
      <div class="card-title">Distance 1 History</div>
      <div class="chart-container">
        <canvas id="distance1-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Dashboard for Distance 2 -->
  <div class="dashboard" id="dashboard2">
    <!-- Distance and Frequency Cards -->
    <div class="card-grid">
      <div class="card" id="distance2-card">
        <div class="card-title">Current Distance 2</div>
        <div class="card-content" id="distance2-display">0.00 cm</div>
      </div>
      <div class="card" id="frequency2-card">
        <div class="card-title">Current Frequency 2</div>
        <div class="card-content" id="frequency2-display">0.00 Hz</div>
      </div>
    </div>

    <!-- Distance 2 History Chart -->
    <div class="card">
      <div class="card-title">Distance 2 History</div>
      <div class="chart-container">
        <canvas id="distance2-chart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let distance1 = 0, distance2 = 0;
    let frequency1 = 0, frequency2 = 0;
    let isConnected = false;

    // Chart.js contexts
    const distance1ChartCtx = document.getElementById('distance1-chart').getContext('2d');
    const distance2ChartCtx = document.getElementById('distance2-chart').getContext('2d');

    // Historical data for charts
    let distance1History = Array(20).fill({ time: new Date().toISOString(), distance: 0 });
    let distance2History = Array(20).fill({ time: new Date().toISOString(), distance: 0 });

    // Distance and Frequency displays
    const distance1Display = document.getElementById('distance1-display');
    const distance2Display = document.getElementById('distance2-display');
    const frequency1Display = document.getElementById('frequency1-display');
    const frequency2Display = document.getElementById('frequency2-display');

    // Connect button
    const connectBtn = document.getElementById('connect-btn');

    // Chart.js setups
    const distance1Chart = new Chart(distance1ChartCtx, {
      type: 'line',
      data: {
        labels: distance1History.map(d => new Date(d.time).toLocaleTimeString()),
        datasets: [{
          label: 'Distance 1',
          data: distance1History.map(d => d.distance),
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 2,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        scales: { x: { type: 'time', time: { unit: 'second' } }, y: { beginAtZero: true } }
      }
    });

    const distance2Chart = new Chart(distance2ChartCtx, {
      type: 'line',
      data: {
        labels: distance2History.map(d => new Date(d.time).toLocaleTimeString()),
        datasets: [{
          label: 'Distance 2',
          data: distance2History.map(d => d.distance),
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 2,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        scales: { x: { type: 'time', time: { unit: 'second' } }, y: { beginAtZero: true } }
      }
    });

    // Simulate Bluetooth connection
    async function connectToBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['battery_service'] }]
        });

        console.log('Connecting to Bluetooth Device...');
        const server = await device.gatt.connect();
        console.log('Connected to Bluetooth Device');

        isConnected = true;
        connectBtn.textContent = 'Disconnect';
        connectBtn.classList.remove('disconnected');

        // Assuming receiving data from the device over time
        setInterval(() => {
          if (isConnected) {
            distance1 = Math.random() * 100;
            distance2 = Math.random() * 100;
            frequency1 = distance1 * 10;
            frequency2 = distance2 * 10;

            distance1Display.textContent = `${distance1.toFixed(2)} cm`;
            distance2Display.textContent = `${distance2.toFixed(2)} cm`;
            frequency1Display.textContent = `${frequency1.toFixed(2)} Hz`;
            frequency2Display.textContent = `${frequency2.toFixed(2)} Hz`;

            updateDistanceHistory(distance1, distance2);
          }
        }, 1000);
      } catch (error) {
        console.error('Bluetooth Connection Error: ', error);
      }
    }

    function updateDistanceHistory(newDistance1, newDistance2) {
      const newTime = new Date().toISOString();

      distance1History.push({ time: newTime, distance: newDistance1 });
      distance1History.shift();
      distance1Chart.data.labels = distance1History.map(d => new Date(d.time).toLocaleTimeString());
      distance1Chart.data.datasets[0].data = distance1History.map(d => d.distance);
      distance1Chart.update();

      distance2History.push({ time: newTime, distance: newDistance2 });
      distance2History.shift();
      distance2Chart.data.labels = distance2History.map(d => new Date(d.time).toLocaleTimeString());
      distance2Chart.data.datasets[0].data = distance2History.map(d => d.distance);
      distance2Chart.update();
    }

    // Handle connect/disconnect button click
    connectBtn.addEventListener('click', () => {
      if (isConnected) {
        handleDisconnection();
      } else {
        connectToBluetooth();
      }
    });

    // Handle disconnection
    function handleDisconnection() {
      isConnected = false;
      connectBtn.textContent = 'Connect';
      connectBtn.classList.add('disconnected');
      distance1Display.textContent = '0.00 cm';
      distance2Display.textContent = '0.00 cm';
      frequency1Display.textContent = '0.00 Hz';
      frequency2Display.textContent = '0.00 Hz';
    }
  </script>
</body>
</html>
